#!/bin/bash
#
# Copyright:: Copyright 2017 Chef Software, Inc.
# License:: Apache License, Version 2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

set -eo pipefail

function usage() {
  cat <<DOC
Usage: ${0##*/} [PROFILE]

A non-interactive version of 'aws configure' that allows you to configure AWS CLI profiles.

To add a new profile, you MUST specify following environment variables:

    * <PROFILE>_AWS_ACCESS_KEY_ID
    * <PROFILE>_AWS_SECRET_ACCESS_KEY

You can optionally specify '<PROFILE>_AWS_DEFAULT_REGION' to determine the default region for this profile.

SUBCOMMANDS:
    is-configured PROFILE     Returns '0' if the profile is configured. Otherwise, it returns '1'.
DOC
}

function setup_profile() {
  profile=$1
  profile_env="$(echo "$profile" | awk '{ print toupper($0) }' | tr '-' '_')"

  if [[ -z "$profile" ]]; then
    echo -e "${0##*/}: No profile specified. You must specify an AWS profile to configure.\\n"
    usage
    exit 2
  fi

  mkdir -p "$HOME/.aws"

  access_key_id="${profile_env}_AWS_ACCESS_KEY_ID"
  secret_access_key="${profile_env}_AWS_SECRET_ACCESS_KEY"
  region="${profile_env}_AWS_DEFAULT_REGION"

  if [[ -z "${!access_key_id}" || -z "${!secret_access_key}" ]]; then
    echo "${0##*/}: Unable to find the required environment variables: $access_key_id and $secret_access_key."
    echo "Make sure that both are specified."
    exit 2
  fi

  if is_configured "$profile"; then
    echo "${0##*/}: $profile has already been configured."
  else
    aws configure set aws_access_key_id "${!access_key_id}" --profile "$profile"
    aws configure set aws_secret_access_key "${!secret_access_key}" --profile "$profile"
    aws configure set region "${!region:-us-east-1}" --profile "$profile"
  fi
}

function is_configured() {
  aws --profile "$1" configure list || false
}

case "${1:-}" in
  "-h"|"--help")
    usage
    ;;
  "is-configured")
    is_configured "$2"
    ;;
  *)
    setup_profile "$1"
    ;;
esac
